> Computer Architecture H Lab 1
>
> 郭耸霄 PB20111712 Mar 31, 2023

[TOC]

#### 1

> 描述执行一条 XOR 指令的过程（数据通路、控制信号等）

- 数据通路：

  - IF：从指令存储器中读取指令，并将 PC 加 4。
  - ID：从寄存器文件中读取 rs1 和 rs2 的内容，并将指令的 rd 字段作为目的寄存器号。
  - EX：将 rs1 和 rs2 的内容送入 ALU，得到运算结果。
  - MEM：无。
  - WB：将 ALU 的运算结果写入目的寄存器 rd 中。

- 控制信号：

  | Jal  | Jalr | Op2  | ALU Func | Cache Write | Load NPC | WB Select | Load Type | Op1  | RegWrite | ImmType | BrType |
  | ---- | ---- | ---- | -------- | ----------- | -------- | --------- | --------- | ---- | -------- | ------- | ------ |
  | 0    | 0    | Reg  | XOR      | 0           | ALU Out  | Result    | 0         | Op1  | 1        | R       | 0      |

#### 2

>描述执行一条 BEQ 指令的过程·（数据通路、控制信号等）

- 数据通路：

  - IF：从指令存储器中读取指令，并将 PC 加 4。
  - ID：从寄存器文件中读取 rs1 和 rs2 的内容，计算 Imm。
  - EX：将 rs1 和 rs2 的内容送入 Branch Module，得到跳转结果；计算 PC + Imm。
  - MEM：无。
  - WB：无。

- 控制信号：

  | Jal  | Jalr | Op2  | ALU Func | Cache Write | Load NPC | WB Select | Load Type | Op1  | RegWrite | ImmType | BrType |
  | ---- | ---- | ---- | -------- | ----------- | -------- | --------- | --------- | ---- | -------- | ------- | ------ |
  | 0    | 0    | Op2  | 0        | 0           | 0        | 0         | 0         | Op1  | 0        | SB      | BEQ    |

#### 3

> 描述执行一条 LHU 指令的过程（数据通路、控制信号等）

- 数据通路：

  - IF：从指令存储器中读取指令，并将 PC 加 4。
  - ID：从寄存器文件中读取 rs1 和 rs2 的内容，计算 Imm。
  - EX：将 rs1 和 Imm 的内容送入 ALU，得到运算结果。
  - MEM：利用 ALU 结果作为访存地址，读取内存内容。
  - WB：将 Data Cache 的读取结果取指定的半字，存入目的寄存器 rd 中。

- 控制信号：

  | Jal  | Jalr | Op2  | ALU Func | Cache Write | Load NPC | WB Select      | Load Type | Op1  | RegWrite | ImmType | BrType |
  | ---- | ---- | ---- | -------- | ----------- | -------- | -------------- | --------- | ---- | -------- | ------- | ------ |
  | 0    | 0    | imm  | ADD      | 0           | ALU Out  | Data Extension | LHU       | Op1  | 1        | I       | 0      |

#### 4

> 如果要实现 CSR 指令（csrrw，csrrs，csrrc，csrrwi，csrrsi，csrrci），设计图中还需要增加什么部件和数据通路？给出详细说明。 

- 一个 CSR 寄存器模块，用于存储和更新不同的控制和状态寄存器，例如 mstatus。
- 一个 CSR 译码模块，用于解析指令中的 CSR 索引、源操作数、目的操作数和操作类型。
- 一个 CSR 执行模块，用于根据操作类型对 CSR 寄存器进行读、写或置位/清零操作，并生成写回数据寄存器的结果。
- 一个 CSR 数据通路，用于连接 CSR 寄存器模块、CSR 译码模块、CSR 执行模块和数据寄存器模块。

#### 5

> Verilog 如何实现立即数的扩展？ 

- 使用符号扩展运算符（\$signed）和位宽指定符（'）来将立即数转换为有符号数，并指定扩展后的位宽。
- 使用重复连接运算符（{}）和最高位（[n-1]）来将立即数按照最高位的符号进行扩展。
- 使用移位运算符（<<）和减法运算符（-）来将立即数左移并减去自身。

#### 6

> 如何实现 Data Memory 的非字对齐的 Load 和 Store？ 

- 使用字节寻址的方式，即将 Data Memory 分为若干个字节单元，每个字节单元有一个地址，然后根据 Load 和 Store 的地址和长度，选择相应的字节单元进行读写操作。
- 使用旋转移位器的方式，即将 Data Memory 分为若干个字单元，每个字单元有一个地址，然后根据 Load 和 Store 的地址和长度，选择相应的字单元进行读写操作，并通过旋转移位器将数据对齐到目标位置。
- 使用掩码寄存器的方式，即将 Data Memory 分为若干个字单元，每个字单元有一个地址，然后根据 Load 和 Store 的地址和长度，选择相应的字单元进行读写操作，并通过掩码寄存器将数据中的无效部分屏蔽掉。

#### 7

>ALU 模块中，默认 wire 变量是有符号数还是无符号数？ 

无符号数。

#### 8

>简述 BR 信号的作用。

BR 信号表明是否有条件跳转指令发生了跳转。

#### 9

>NPC Generator 中对于不同跳转 target 的选择有没有优先级？ 

Jalr 和 Br 的跳转地址在 EX 段被计算出来，Jal 的地址在 ID 被计算出来。

当流水线的 EX 段是 Jalr 或 Br，且 ID 段式 Jal 时，会先响应 Jalr 或 Br ，不再响应 Jal 。因为这相当于代码中 Jalr 或 Br 指令在 Jal 之前。

10

>Harzard 模块中，有哪几类冲突需要插入气泡，分别使流水线停顿几个周期？ 

- 数据冲突，Load 指令和 ALU 指令的 RAW 相关需要在 ALU 指令 IF 段插入一个气泡。
- 控制冲突：如果采用静态分支预测，形如 BEQ R1,R2,Label; JAL R3, Label 的指令序列，需要在后一条指令的 IF 段插入两个气泡。

11

>Harzard 模块中采用静态分支预测器，即默认不跳转，遇到 branch指令时，如何控制 flush 和 stall 信号？ 

在 EX 段，若跳转结果为不跳转，则无 flush；若跳转结果为跳转，则 flush IF 和 ID 段（此时是跳转指令不跳转的下一条指令），PC 更新为新的指令地址。

12

> 0 号寄存器值始终为 0，是否会对 forward 的处理产生影响？

是的，当两条数据相关指令中的前一条向 0 号寄存器写非 0 值，且后一条指令使用 0 号寄存器作为源寄存器时，需要特别处理，否则会前递一个非 0 值作为后一条指令的源，产生错误。
